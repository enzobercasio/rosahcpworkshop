<!doctype html><html lang=en-us dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Introduction
  #

ROSA is designed with high availability and resiliency in mind. Within ROSA there are multiple tools at your disposal to leverage this highly available and resilient architecture to ensure maximum uptime and availability for your applications. Disruptions can occur for a variety of different reasons, but with proper configuration of the application, you can eliminate application disruption.
Limits and Requests can be used to both allocate and restrict the amount of resources an application can use, pod disruption budgets ensure that you always have a particular number of your application pods running and the Horizontal Pod Autoscaler can automatically increase and decrease pod count as needed."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://localhost:1313/docs/lab_12_resilient_app/"><meta property="og:site_name" content="ROSA HCP Workshop"><meta property="og:title" content="Make your application resilient"><meta property="og:description" content="Introduction # ROSA is designed with high availability and resiliency in mind. Within ROSA there are multiple tools at your disposal to leverage this highly available and resilient architecture to ensure maximum uptime and availability for your applications. Disruptions can occur for a variety of different reasons, but with proper configuration of the application, you can eliminate application disruption.
Limits and Requests can be used to both allocate and restrict the amount of resources an application can use, pod disruption budgets ensure that you always have a particular number of your application pods running and the Horizontal Pod Autoscaler can automatically increase and decrease pod count as needed."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>Lab 12 - Make your application resilient | ROSA HCP Workshop</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=http://localhost:1313/docs/lab_12_resilient_app/><link rel=stylesheet href=/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.ca88b67f90f2aca8c1ccdfcf37144b0397e3ad38fe5d87c9ecc7beed176c7a67.js integrity="sha256-yoi2f5DyrKjBzN/PNxRLA5fjrTj+XYfJ7Me+7Rdsemc=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>ROSA HCP Workshop</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/docs/lab_1_explore_rosa/>Lab 1 - Explore the environment</a></li><li><a href=/docs/lab_2_cluster_creation_hcp/>Lab 2 - Create a ROSA HCP Cluster</a></li><li><a href=/docs/lab_3_access_cluster/>Lab 3 - Access ROSA HCP Cluster</a></li><li><a href=/docs/lab_4_cluster_upgrade/>Lab 4 - Upgrade ROSA HCP Cluster</a></li><li><a href=/docs/lab_5_managing_worker_nodes-copy/>Lab 5 - Managing Worker Nodes</a></li><li><a href=/docs/lab_6_labeling_nodes/>Lab 6 - Labeling Worker Nodes</a></li><li><a href=/docs/lab_7_autoscaling/>Lab 7 - Autoscaling ROSA HCP Cluster</a></li><li><a href=/docs/lab_8_cloudwatch/>Lab 8 - Configure Red Hat OpenShift Logging with AWS Cloudwatch</a></li><li><a href=/docs/lab_9_deploy_app/>Lab 9 - Deploy an application with AWS Database</a></li><li><a href=/docs/lab_10_openshift_gitops/>Lab 10 - Deploy an application with Red Hat OpenShift GitOps</a></li><li><a href=/docs/lab_11_network_policy/>Lab 11 - Secure your applications with Network Policies</a></li><li><a href=/docs/lab_12_resilient_app/ class=active>Lab 12 - Make your application resilient</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>Lab 12 - Make your application resilient</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#setting-limits-and-requests-on-an-application>Setting Limits and Requests on an Application</a></li><li><a href=#pod-disruption-budget>Pod Disruption Budget</a></li><li><a href=#horizontal-pod-autoscaler>Horizontal Pod Autoscaler</a></li><li><a href=#summary>Summary</a></li></ul></nav></aside></header><article class="markdown book-article"><h2 id=introduction>Introduction
<a class=anchor href=#introduction>#</a></h2><p>ROSA is designed with high availability and resiliency in mind. Within ROSA there are multiple tools at your disposal to leverage this highly available and resilient architecture to ensure maximum uptime and availability for your applications. Disruptions can occur for a variety of different reasons, but with proper configuration of the application, you can eliminate application disruption.</p><p>Limits and Requests can be used to both allocate and restrict the amount of resources an application can use, pod disruption budgets ensure that you always have a particular number of your application pods running and the Horizontal Pod Autoscaler can automatically increase and decrease pod count as needed.</p><p>In this section of the workshop, we will use the previously deployed microsweeper application, ensure the application is resilient to node failure, and scale the application when under load.</p><h2 id=setting-limits-and-requests-on-an-application>Setting Limits and Requests on an Application
<a class=anchor href=#setting-limits-and-requests-on-an-application>#</a></h2><ol><li><p>First, let’s set limits and requests on the previously deployed microsweeper application.</p><pre><code>  oc -n microsweeper-ex set resources deployment/microsweeper-appservice \
     --limits=cpu=60m,memory=250Mi \
     --requests=cpu=50m,memory=200Mi
</code></pre><p>Requests state the minimum CPU and memory requirements for a container. This will ensure that the pod is placed on a node that can meet those requirements. Limits set the maximum amount of CPU and Memory that can be consumed by a container and ensure that a whole container does not consume all of the resources on a node. Setting limits and requests for deployments is best practice for resource management and ensuring the stability and reliability of your applications.</p><pre><code> oc adm top pods -n microsweeper-ex
</code></pre><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>NAME                                       CPU(cores)   MEMORY(bytes)
</span></span><span style=display:flex><span>microsweeper-appservice-65799476b6-vh9q7   0m           191Mi
</span></span></code></pre></div></li><li><p>Now that we’ve updated the resource, we can see that a new pod was automatically rolled out with these new limits and requests. To do so, run the following command.</p><pre><code> oc get pods -n microsweeper-ex
</code></pre><p>We’ll see a new pod (created 28 seconds earlier in this case):</p><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>[user0_mobbws@bastion ~]$ oc get pods microsweeper-ex
</span></span><span style=display:flex><span>NAME                                       READY   STATUS      RESTARTS   AGE
</span></span><span style=display:flex><span>microsweeper-appservice-1-build            0/1     Completed   0          17h
</span></span><span style=display:flex><span>microsweeper-appservice-69596ccc54-fsw2b   1/1     Running      0          28s
</span></span></code></pre></div><p>To see what the limits and requests added to the pod, run the following command:</p><pre><code> oc get pods -l app.kubernetes.io/name=microsweeper-appservice \
     -o yaml -n microsweeper-ex | grep limits -A5
</code></pre><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>    limits:
</span></span><span style=display:flex><span>        cpu: 60m
</span></span><span style=display:flex><span>        memory: 250Mi
</span></span><span style=display:flex><span>    requests:
</span></span><span style=display:flex><span>        cpu: 50m
</span></span><span style=display:flex><span>        memory: 200Mi
</span></span></code></pre></div></li><li><p>We can now use the route of the application to ensure the application is functioning with the new limits and requests. To get the route, run the following command</p><pre><code>oc -n microsweeper-ex get route microsweeper-appservice \
 -o jsonpath='http://{.spec.host}{&quot;\n&quot;}'    
</code></pre><p>Then visit the URL presented in a new tab in your web browser (using HTTP). For example, your output will look something similar to:</p><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>http://microsweeper-appservice-microsweeper-ex.apps.test-cluster.2ubs.p1.openshiftapps.com
</span></span></code></pre></div><p>In that case, you’d visit <code>http://microsweeper-appservice-microsweeper-ex.apps.test-cluster.2ubs.p1.openshiftapps.com</code> in your browser.</p></li><li><p>Initially, this application is deployed with only one pod. In the event a worker node goes down or the pod crashes, there will be an outage of the application. To prevent that, let’s scale the number of instances of our applications up to three. To do so, run the following command</p><pre><code> oc -n microsweeper-ex scale deployment \
     microsweeper-appservice --replicas=3
</code></pre></li><li><p>Next, let’s check to see that the application has scaled. To do so, run the following command to see the pods</p><pre><code> oc -n microsweeper-ex get pods
</code></pre><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>NAME                                       READY   STATUS      RESTARTS   AGE
</span></span><span style=display:flex><span>microsweeper-appservice-1-build            0/1     Completed   0          18h
</span></span><span style=display:flex><span>microsweeper-appservice-69596ccc54-6lstj   1/1     Running     0          2m41s
</span></span><span style=display:flex><span>microsweeper-appservice-69596ccc54-fsw2b   1/1     Running     0          39m
</span></span><span style=display:flex><span>microsweeper-appservice-69596ccc54-rkpgj   1/1     Running     0          2m41s
</span></span></code></pre></div></li><li><p>In addition you can see the number of pods, how many are on the current version, and how many are available by running the following</p><pre><code> oc -n microsweeper-ex get deployment microsweeper-appservice
</code></pre><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>microsweeper-appservice   3/3     3            3           18h
</span></span></code></pre></div></li></ol><h2 id=pod-disruption-budget>Pod Disruption Budget
<a class=anchor href=#pod-disruption-budget>#</a></h2><p>A Pod Disruption Budget (PDB) allows you to limit the disruption to your application when its pods need to be rescheduled for upgrades or routine maintenance work on ROSA nodes. In essence, it lets developers define the minimum tolerable operational requirements for a deployment so that it remains stable even during a disruption.</p><p>For example, microsweeper-appservice deployed as part of the last step contains three replicas distributed evenly across three nodes. We can tolerate losing one pod, so we create a PDB that requires a minimum of one replica.</p><p>A <code>PodDisruptionBudget</code> object’s configuration consists of the following key parts:</p><ul><li><p>A label selector, which is a label query over a set of pods.</p></li><li><p>An availability level, which specifies the minimum number of pods that must be available simultaneously, either:</p><ul><li>minAvailable is the number of pods that must always be available, even during a disruption.</li><li>maxUnavailable is the number of pods that can be unavailable during a disruption.</li></ul></li></ul><p>Warning: A maxUnavailable of 0% or 0 or a minAvailable of 100% or equal to the number of replicas can be used but will block nodes from being drained and can result in application instability during maintenance activities.</p><ol><li><p>Let’s create a Pod Disruption Budget for our <code>microsweeper-appservice</code> application. To do so, run the following command.</p><pre><code> cat &lt;&lt;EOF | oc apply -f -
 apiVersion: policy/v1
 kind: PodDisruptionBudget
 metadata:
 name: microsweeper-appservice-pdb
 namespace: microsweeper-ex
 spec:
 minAvailable: 1
 selector:
     matchLabels:
     deployment: microsweeper-appservice
 EOF
</code></pre><p>After creating the PDB, the OpenShift API will ensure at least one pod of <code>microsweeper-appservice</code> is running all the time, even when maintenance is going on within the cluster.</p></li><li><p>Next, let’s check the status of Pod Disruption Budget. To do so, run the following command</p><pre><code> oc -n microsweeper-ex get poddisruptionbudgets
</code></pre><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>NAME              MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
</span></span><span style=display:flex><span>microsweeper-appservice-pdb   1               N/A               0         39s
</span></span></code></pre></div></li></ol><h2 id=horizontal-pod-autoscaler>Horizontal Pod Autoscaler
<a class=anchor href=#horizontal-pod-autoscaler>#</a></h2><p>As a developer, you can utilize a horizontal pod autoscaler (HPA) in ROSA clusters to automate scaling of replication controllers or deployment configurations. The HPA adjusts the scale based on metrics gathered from the associated pods. It is applicable to deployments, replica sets, replication controllers, and stateful sets.</p><p>The HPA (Horizontal Pod Autoscaler) provides you with automated scaling capabilities, optimizing resource management and improving application performance. By leveraging an HPA, you can ensure your applications dynamically scale up or down based on workload. This automation reduces the manual effort of adjusting application scale and ensures efficient resource utilization, by only using resources that are needed at a certain time. Additionally, the HPA’s ease of configuration and compatibility with various workload types make it a flexible and scalable solution for developers in managing their applications.</p><p>In this exercise we will scale the microsweeper-appservice application based on CPU utilization:</p><ul><li><p>Scale out when average CPU utilization is greater than 50% of CPU limit</p></li><li><p>Maximum pods is 4</p></li><li><p>Scale down to min replicas if utilization is lower than threshold for 60 sec</p></li></ul><ol><li><p>First, we should create the HorizontalPodAutoscaler. To do so, run the following command</p><pre><code> cat &lt;&lt;EOF | oc apply -f -
 apiVersion: autoscaling/v2
 kind: HorizontalPodAutoscaler
 metadata:
 name: microsweeper-appservice-cpu
 namespace: microsweeper-ex
 spec:
 scaleTargetRef:
     apiVersion: apps/v1
     kind: Deployment
     name: microsweeper-appservice
 minReplicas: 2
 maxReplicas: 4
 metrics:
     - type: Resource
     resource:
         name: cpu
         target:
         averageUtilization: 50
         type: Utilization
 behavior:
     scaleDown:
     stabilizationWindowSeconds: 60
     policies:
     - type: Percent
         value: 100
         periodSeconds: 15
 EOF
</code></pre></li><li><p>Next, check the status of the HPA. To do so, run the following command</p><pre><code> oc -n microsweeper-ex get horizontalpodautoscaler/microsweeper-appservice-cpu
</code></pre><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>NAME              REFERENCE                                        TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style=display:flex><span>microsweeper-appservice-cpu   Deployment/microsweeper-appservice   0%/50%    2         4         3          43s
</span></span></code></pre></div></li><li><p>Next, let’s generate some load against the <code>microsweeper-appservice</code> application. To do so, run the following command</p><pre><code> FRONTEND_URL=http://$(oc -n microsweeper-ex get route microsweeper-appservice -o jsonpath='{.spec.host}')/

 ab -c100 -n10000 ${FRONTEND_URL}
</code></pre></li><li><p>Apache Bench will take around 100 seconds to complete (you can also hit CTRL-C to kill the ab command). Then immediately check the status of Horizontal Pod Autoscaler. To do so, run the following command:</p><pre><code> oc -n microsweeper-ex get horizontalpodautoscaler/microsweeper-appservice-cpu
</code></pre><p>Sample Output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>NAME                          REFERENCE                            TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style=display:flex><span>microsweeper-appservice-cpu   Deployment/microsweeper-appservice   135%/50%   2         4         4          7m37s
</span></span></code></pre></div><p>This means you are now running 4 replicas, instead of the original three that we started with.</p></li><li><p>Once you’ve killed the <code>ab</code> command, the traffic going to <code>microsweeper-appservice</code> service will cool down and after a 60 second cool down period, your application’s replica count will drop back down to two. To demonstrate this, run the following command</p><pre><code> oc -n microsweeper-ex get horizontalpodautoscaler/microsweeper-appservice-cpu --watch
</code></pre><p>After a minute or two, your output should be similar to below</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tpl data-lang=tpl><span style=display:flex><span>NAME                          REFERENCE                            TARGETS    MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style=display:flex><span>microsweeper-appservice-cpu   Deployment/microsweeper-appservice   0%/50%     2         4         4          19m
</span></span><span style=display:flex><span>microsweeper-appservice-cpu   Deployment/microsweeper-appservice   0%/50%     2         4         4          19m
</span></span><span style=display:flex><span>microsweeper-appservice-cpu   Deployment/microsweeper-appservice   0%/50%     2         4         2          20m
</span></span></code></pre></div></li></ol><h2 id=summary>Summary
<a class=anchor href=#summary>#</a></h2><p>Here’s what you learned:</p><ul><li><p>Set Limits and Requests on the Microsweeper application from the previous section</p></li><li><p>Scale the Microsweeper application up and down</p></li><li><p>Set a Pod Disruption Budget on the Microsweeper application</p></li><li><p>Set a Horizontal Pod Autoscaler to automatically scale application based on load.</p></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#setting-limits-and-requests-on-an-application>Setting Limits and Requests on an Application</a></li><li><a href=#pod-disruption-budget>Pod Disruption Budget</a></li><li><a href=#horizontal-pod-autoscaler>Horizontal Pod Autoscaler</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></aside></main></body></html>